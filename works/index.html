<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ„›çš„æ—…ç¨‹ - å¿ƒéˆçš„ç›¸é‡</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="firebase-auth.css">
    <!-- æ·»åŠ Googleå­—é«” - é©åˆæœ—è®€ä¸»é¡Œçš„å„ªé›…å­—é«” -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
      .header-main { 
        
        justify-content: space-between; 
        align-items: flex-start; 
        padding: 0 24px; 
      }
      .auth-container { 
        min-width: 120px; 
        text-align: right; 
        margin-top: 10px; 
      }
      .class-selector { 
        display: flex; 
        gap: 10px; 
        margin: 24px 0 16px 0; 
        justify-content: center; 
        flex-wrap: wrap;
        padding: 0 1rem;
      }
      .class-btn { 
        padding: 0.8rem 1.8rem; 
        border-radius: 30px; 
        border: none; 
        background: rgba(255, 255, 255, 0.2); 
        color: #fff; 
        font-size: 1em; 
        cursor: pointer; 
        transition: all 0.3s ease; 
        backdrop-filter: blur(10px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      .class-btn.active, .class-btn:hover { 
        background: rgba(255, 255, 255, 0.3); 
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }
      .class-btn.active {
        background: white;
        color: #b68686;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }
      .works-container { 
        display: none; 
        margin-bottom: 32px; 
        animation: fadeIn 0.5s ease-in-out;
      }
      .works-container.active { 
        display: block; 
      }
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }
      .group-section { 
        margin-bottom: 3rem; 
        background: rgba(255, 255, 255, 0.8);
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        border: 1px solid rgba(232, 196, 196, 0.3);
      }
      .group-title { 
        font-size: 1.3rem; 
        font-weight: 600; 
        margin-bottom: 1.5rem; 
        color: #b68686; 
        text-align: center;
        position: relative;
        padding-bottom: 0.5rem;
      }
      .group-title:after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 60px;
        height: 2px;
        background: linear-gradient(to right, #e8c4c4, #d3a5a5);
      }
      .works-grid { 
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 2rem;
        margin-top: 1.5rem;
      }
      .work-item { 
        background: #fff; 
        border-radius: 15px; 
        box-shadow: 0 4px 20px rgba(0,0,0,0.08); 
        overflow: hidden;
        border: 1px solid #f0e6e0;
        transition: all 0.3s ease;
        position: relative;
        backdrop-filter: blur(10px);
      }
      .work-item:hover {
        transform: translateY(-8px);
        box-shadow: 0 15px 30px rgba(158, 118, 118, 0.15);
      }
      .work-title { 
        font-weight: 600; 
        font-size: 1.2rem; 
        margin-bottom: 6px; 
        color: #9e7676;
        padding: 1.2rem;
        text-align: center;
        border-top: 1px solid #f0e6e0;
        line-height: 1.4;
      }
      .work-meta { 
        color: #888; 
        font-size: 0.95em; 
        margin-bottom: 8px; 
      }
      .video-container { 
        margin-bottom: 8px; 
        position: relative;
        padding-bottom: 56.25%;
        height: 0;
        overflow: hidden;
        background-color: #000;
        border-bottom: 2px solid #e8c4c4;
      }
      .video-container iframe {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border: 0;
      }
      .student-name {
        background: linear-gradient(135deg, #e8c4c4, #d3a5a5);
        color: white;
        padding: 1rem 1.2rem;
        text-align: center;
        font-weight: 600;
        font-size: 1.1rem;
        line-height: 1.4;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
      }
      .comments-section {
        border-top: 1px solid #f0e6e0;
      }
      .comments-header {
        padding: 1rem 1.2rem;
        background: linear-gradient(135deg, #f8f0f0, #f0e6e0);
        cursor: pointer;
        transition: all 0.3s ease;
        border-bottom: 1px solid #e8c4c4;
      }
      .comments-header:hover {
        background: linear-gradient(135deg, #f0e6e0, #e8c4c4);
      }
      .comments-title {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 600;
        color: #9e7676;
      }
      .comments-count {
        background: #b68686;
        color: white;
        padding: 0.2rem 0.6rem;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 500;
      }
      .comments-content {
        background: #fff;
        padding: 1.2rem;
      }
      .comment {
        border-bottom: 1px solid #f0e6e0;
        padding: 1rem 0;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
      }
      .comment:hover {
        background: rgba(232, 196, 196, 0.05);
        border-radius: 8px;
        padding-left: 0.5rem;
      }
      .comment-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.8rem;
        font-size: 0.9rem;
        color: #666;
      }
      .commenter-info {
        display: flex;
        align-items: center;
        gap: 0.8rem;
      }
      .commenter-name {
        font-weight: 600;
        color: #9e7676;
      }
      .commenter-class {
        color: #888;
        font-size: 0.8rem;
      }
      .rating-stars {
        color: #e8c4c4;
        font-size: 1rem;
      }
      .comment-content {
        font-size: 0.95rem;
        line-height: 1.6;
        color: #333;
        padding: 0.5rem 0;
      }
      .comments-pagination {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #f0e6e0;
      }
      .page-button {
        padding: 0.5rem 0.8rem;
        border: 1px solid #e8c4c4;
        background: #fff;
        color: #9e7676;
        cursor: pointer;
        border-radius: 6px;
        transition: all 0.3s ease;
        font-weight: 500;
      }
      .page-button:hover {
        background: #f8f0f0;
        transform: translateY(-1px);
      }
      .page-button.active {
        background: #b68686;
        color: white;
        border-color: #b68686;
      }
      .loading-indicator {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-size: 16px;
        z-index: 100;
        background: rgba(0, 0, 0, 0.7);
        padding: 1rem 1.5rem;
        border-radius: 8px;
        backdrop-filter: blur(5px);
      }
      .auth-btn {
        background: linear-gradient(135deg, #e8c4c4, #d3a5a5);
        color: white;
        border: none;
        border-radius: 20px;
        padding: 0.6rem 1.2rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.9rem;
      }
      .auth-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(158, 118, 118, 0.2);
      }
      
      /* ç™»å…¥ Modal æ¨£å¼ */
      .tab-btn {
        flex: 1;
        padding: 0.8rem;
        border: none;
        background: none;
        color: #999;
        cursor: pointer;
        transition: all 0.3s ease;
        border-bottom: 2px solid transparent;
      }
      
      .tab-btn.active {
        color: #b68686;
        border-bottom-color: #b68686;
      }
      
      .tab-btn:hover {
        color: #b68686;
      }
      
      .login-form {
        transition: all 0.3s ease;
      }
      
      .login-form input:focus {
        outline: none;
        border-color: #b68686;
        box-shadow: 0 0 0 2px rgba(182, 134, 134, 0.2);
      }
      
      /* æˆåŠŸ/éŒ¯èª¤è¨Šæ¯æ¨£å¼ */
      .message {
        padding: 0.8rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        text-align: center;
      }
      
      .message.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      
      .message.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      
      @media (max-width: 768px) {
        .works-grid {
          grid-template-columns: 1fr;
          gap: 1.5rem;
        }
        .group-section {
          padding: 1rem;
          margin-bottom: 2rem;
        }
        .work-item {
          margin: 0 0.5rem;
        }
        .student-name {
          font-size: 1rem;
          padding: 0.8rem 1rem;
        }
        .work-title {
          font-size: 1.1rem;
          padding: 1rem;
        }
      }
      @media (max-width: 480px) {
        main {
          padding: 1rem 0.5rem;
        }
        .works-grid {
          gap: 1rem;
        }
        .group-section {
          padding: 0.8rem;
        }
        .comments-content {
          padding: 1rem;
        }
      }
      #auth-container {
        position: fixed; top: 24px; right: 24px; z-index: 2000;
        min-width: 0; text-align: right;
      }
      .auth-fab {
        width: 48px; height: 48px; border-radius: 50%; background: #e8c4c4;
        color: #fff; font-size: 1.5em; font-weight: bold; display: flex; align-items: center; justify-content: center;
        box-shadow: 0 2px 8px #0002; cursor: pointer; position: relative;
        transition: box-shadow 0.2s;
      }
      .auth-fab:hover { box-shadow: 0 4px 16px #b6868640; }
      .auth-fab-avatar { font-size: 1.2em; }
      .auth-fab-arrow { position: absolute; right: 8px; bottom: 6px; font-size: 0.8em; color: #fff8; }
      .auth-panel {
        background: #fff; border-radius: 12px; box-shadow: 0 2px 8px #0001;
        margin-top: 8px; padding: 1rem 1.2rem; min-width: 180px;
        display: block; position: absolute; right: 0; top: 56px;
        z-index: 10;
      }
      .auth-panel .auth-btn { width: 100%; margin: 0.5em 0 0 0; }
      @media (max-width: 600px) {
        #auth-container { top: 8px; right: 8px; }
        .auth-fab { width: 40px; height: 40px; font-size: 1.1em; }
        .auth-panel { min-width: 120px; padding: 0.7rem 0.6rem; }
      }
      .auth-panel-modern {
        position: fixed; top: 20px; right: 90px; z-index: 2001;
        background: #fff; border-radius: 50px; box-shadow: 0 8px 32px #b6868640;
        padding: 0 2.2rem; min-width: 400px; min-height: 70px; max-width: 90vw;
        display: flex; flex-direction: row; align-items: center; gap: 1.1rem;
        transform: translateX(80%) scale(0.85);
        opacity: 0;
        pointer-events: none;
        transition:
          transform 0.55s cubic-bezier(.4,0,.2,1),
          opacity 0.38s cubic-bezier(.4,0,.2,1),
          box-shadow 0.38s cubic-bezier(.4,0,.2,1);
      }
      .auth-panel-modern.open {
        transform: translateX(0) scale(1);
        opacity: 1;
        pointer-events: auto;
        box-shadow: 0 16px 48px #b6868680;
      }
      .auth-panel-avatar {
        width: 56px; height: 56px; border-radius: 50%;
        background: #e8c4c4; color: #fff; font-size: 2em; font-weight: bold;
        display: flex; align-items: center; justify-content: center;
        margin-right: 0.5rem;
      }
      .auth-panel-info {
        display: flex; flex-direction: column; align-items: flex-start; min-width: 120px;
      }
      .auth-panel-name { font-weight: 700; color: #9e7676; font-size: 1.1em; }
      .auth-panel-meta { color: #888; font-size: 0.98em; margin-top: 2px; }
      .auth-panel-btns {
        display: flex; flex-direction: row; gap: 0.7em; margin-left: auto;
      }
      .auth-btn-modern {
        padding: 0.6em 1.2em; border-radius: 20px; border: none;
        background: linear-gradient(135deg, #e8c4c4, #d3a5a5);
        color: #fff; font-size: 1em; font-weight: 500;
        display: flex; align-items: center; gap: 0.5em;
        cursor: pointer; transition: background 0.2s, box-shadow 0.2s;
      }
      .auth-btn-modern.logout { background: linear-gradient(135deg, #e88, #b77);}
      .auth-btn-modern:hover { box-shadow: 0 2px 12px #b6868640;}
      @media (max-width: 600px) {
        .auth-fab-modern {
          width: 44px; height: 44px; font-size: 1.2em; top: 8px; right: 8px;
        }
        .auth-panel-modern {
          position: fixed;
          top: 56px;
          left: 0;
          right: 0;
          margin: -31 auto;
          width: 96vw;
          max-width: 420px;
          min-width: 0;
          padding: 0.7rem 0.7rem 0.5rem 0.7rem;
          border-radius: 22px;
          min-height: 0;
          flex-direction: column;
          align-items: stretch;
          gap: 0.5rem;
          transform: translateY(-40%) scale(0.95);
          opacity: 0;
          pointer-events: none;
          transition:
            transform 0.5s cubic-bezier(.4,0,.2,1),
            opacity 0.32s cubic-bezier(.4,0,.2,1),
            box-shadow 0.32s cubic-bezier(.4,0,.2,1);
        }
        .auth-panel-modern.open {
          transform: translateY(0) scale(1);
          opacity: 1;
          pointer-events: auto;
          box-shadow: 0 8px 32px #b6868680;
        }
        .auth-panel-avatar {
          width: 36px; height: 36px; font-size: 1em;
          margin: 0 auto 0.2rem auto;
        }
        .auth-panel-info {
          min-width: 0;
          font-size: 0.95em;
          align-items: center;
          text-align: center;
          margin-bottom: 0.2rem;
        }
        .auth-panel-name { font-size: 1em; }
        .auth-panel-meta { font-size: 0.9em; }
        .auth-panel-btns {
          gap: 0.3em;
          flex-wrap: wrap;
          margin-left: 0;
          justify-content: center;
          display: flex;
        }
        .auth-btn-modern {
          padding: 0.38em 0.7em;
          font-size: 0.92em;
          border-radius: 13px;
        }
      }
      .year-selector { display: flex; gap: 10px; justify-content: center; margin-bottom: 10px; }
      .year-btn { padding: 0.6em 1.4em; border-radius: 20px; border: none; background: #fff; color: #b68686; font-size: 1em; font-weight: 500; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px #b6868620; }
      .year-btn.active, .year-btn:hover { background: #b68686; color: #fff; box-shadow: 0 4px 16px #b6868640; }
    </style>
</head>
<body>
    <header>
        <div class="header-main">
            <div>
                <h1 class="fade-in">æƒ…è©©æœ—è®€ç·šä¸Šæˆæœå±•</h1>
                <p class="fade-in" style="color: #fff; margin-top: 10px;">æŒ‡å°è€å¸«ï¼šå—è‡ºç§‘æŠ€å¤§å­¸ / é§±è‚²è±</p>
            </div>
            <!-- <div id="auth-container" class="auth-container"></div> -->
        </div>
        <div id="year-selector" class="year-selector" style="display:flex;gap:10px;justify-content:center;margin:18px 0 0 0;"></div>
        <nav class="class-selector" id="class-selector"></nav>
    </header>
    <main id="main-content"></main>
    
    <!-- ç™»å…¥ Modal -->
    <div id="login-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.5); z-index: 10000;">
        <div style="position: relative; margin: 5vh auto; background: #fff; padding: 2rem; border-radius: 15px; max-width: 400px; width: 90vw; box-shadow: 0 10px 30px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto;">
            <h2 style="text-align: center; color: #b68686; margin-bottom: 1rem;">ç™»å…¥å€‹äººå°ˆå€</h2>
            <p style="text-align: center; color: #666; font-size: 14px; margin-bottom: 1.5rem;">ç™»å…¥å¾Œå¯ç®¡ç†å€‹äººä½œå“ã€ä¸Šå‚³æ–°ä½œå“</p>
            <div id="login-tabs" style="display: flex; margin-bottom: 1.5rem; border-bottom: 2px solid #f0e6e0;">
                <button id="google-tab" class="tab-btn" onclick="switchLoginTab('google')">Google ç™»å…¥</button>
                <button id="anonymous-tab" class="tab-btn" onclick="switchLoginTab('anonymous')">åŒ¿åç™»å…¥</button>
            </div>
            
            <!-- Email ç™»å…¥è¡¨å–® -->
            <div id="email-form" class="login-form">
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; color: #666;">Email</label>
                    <input type="email" id="login-email" placeholder="è«‹è¼¸å…¥ Email" style="width: 100%; padding: 0.8rem; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;">
                </div>
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; color: #666;">å¯†ç¢¼</label>
                    <input type="password" id="login-password" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" style="width: 100%; padding: 0.8rem; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;">
                </div>
                <button onclick="doLoginWithEmail()" class="auth-btn" style="width: 100%; margin-bottom: 1rem;">ç™»å…¥</button>
                <button onclick="showRegisterForm()" class="auth-btn" style="width: 100%; background: #9e7676;">è¨»å†Šæ–°å¸³è™Ÿ</button>
            </div>
            
            <!-- Email è¨»å†Šè¡¨å–®ï¼ˆå‹•æ…‹åˆ‡æ›é¡¯ç¤ºï¼‰ -->
            <div id="register-form-wrap" class="login-form" style="display:none;">
              <form id="register-form-modal">
                <div class="form-group">
                  <label for="reg-email-modal">é›»å­éƒµä»¶:</label>
                  <input type="email" id="reg-email-modal" required>
                </div>
                <div class="form-group">
                  <label for="reg-password-modal">å¯†ç¢¼:</label>
                  <input type="password" id="reg-password-modal" required>
                </div>
                <div class="form-group">
                  <label for="reg-name-modal">å§“å:</label>
                  <input type="text" id="reg-name-modal" required>
                </div>
                <div class="form-group">
                  <label for="reg-studentid-modal">å­¸è™Ÿ:</label>
                  <input type="text" id="reg-studentid-modal" required>
                </div>
                <div class="form-group">
                  <label for="reg-class-modal">ç­ç´š:</label>
                  <select id="reg-class-modal" required><option value="">è¼‰å…¥ä¸­...</option></select>
                </div>
                <div class="form-group">
                  <label for="reg-group-modal">çµ„åˆ¥:</label>
                  <select id="reg-group-modal" required><option value="">è«‹å…ˆé¸æ“‡ç­ç´š</option></select>
                </div>
                <button type="submit" class="submit-btn">è¨»å†Š</button>
                <button type="button" onclick="showLoginForm()" class="auth-btn" style="width:100%;margin-top:10px;">è¿”å›ç™»å…¥</button>
              </form>
            </div>
            
            <!-- Google ç™»å…¥ -->
            <div id="google-form" class="login-form" style="display: none;">
                <p style="text-align: center; color: #666; margin-bottom: 1.5rem;">ä½¿ç”¨ Google å¸³è™Ÿå¿«é€Ÿç™»å…¥</p>
                <button onclick="loginWithGoogle()" class="auth-btn" style="width: 100%; background: #4285f4;">Google ç™»å…¥</button>
            </div>
            
            <!-- åŒ¿åç™»å…¥ -->
            <div id="anonymous-form" class="login-form" style="display: none;">
                <p style="text-align: center; color: #666; margin-bottom: 1.5rem;">ç„¡éœ€å¸³è™Ÿï¼Œå¿«é€Ÿé«”é©—</p>
                <button onclick="loginAnonymously()" class="auth-btn" style="width: 100%; background: #9e7676;">åŒ¿åç™»å…¥</button>
            </div>
            
            <button onclick="closeLoginModal()" style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; color: #999; cursor: pointer;">Ã—</button>
        </div>
    </div>
    
    <footer>
        <p>Â© 2025 æƒ…è©©æœ—è®€ç·šä¸Šæˆæœå±• | ç‰ˆæ¬Šæ‰€æœ‰</p>
    </footer>
    <!-- æµ®å‹•ç™»å…¥å¡ç‰‡ éœæ…‹æ’å…¥ -->
    <div id="auth-fab" class="auth-fab-modern" tabindex="0"></div>
    <div id="auth-panel-modern" class="auth-panel-modern"></div>
    <div id="auth-panel-bg" class="auth-panel-bg" style="display:none;"></div>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <!-- è‡ªè¨‚è…³æœ¬ -->
    <script src="firebase-config.js"></script>
    <script>
      let currentUser = null;
      window.currentProfile = null;
      firebase.auth().onAuthStateChanged(async user => {
        currentUser = user;
        if (user) {
          const users = await window.FirebaseService.getUsers();
          // è½‰æ› users çµæ§‹ç‚ºä»¥ uid ç‚º key
          let usersByUid = {};
          Object.values(users || {}).forEach(u => {
            if (u.uid) usersByUid[u.uid] = u;
          });
          window.currentProfile = Object.values(usersByUid||{}).find(u => u.uid === user.uid);
        } else {
          window.currentProfile = null;
        }
        renderExhibition();
        renderModernAuth();
      });
      
      // ====== cache å„ªåŒ–å€å¡Š ======
      function cacheExhibitionData(data) {
        localStorage.setItem('exhibitionCache', JSON.stringify({ data, ts: Date.now() }));
      }
      function getExhibitionCache() {
        const cache = localStorage.getItem('exhibitionCache');
        if (!cache) return null;
        try {
          const { data, ts } = JSON.parse(cache);
          if (Date.now() - ts < 5 * 60 * 1000) return data; // 5åˆ†é˜å…§æœ‰æ•ˆ
        } catch(e) {}
        return null;
      }
      function isDataEqual(a, b) {
        return JSON.stringify(a) === JSON.stringify(b);
      }
      // ====== cache å„ªåŒ–å€å¡Š end ======

      // å‹•æ…‹æ¸²æŸ“å±•è¦½å€
      async function renderExhibition(data) {
        try {
          let classes, groups, works, comments, users;
          let usersByUid = {};
          if (data) {
            ({ classes, groups, works, comments, users } = data);
            Object.values(users || {}).forEach(u => {
              if (u.uid) usersByUid[u.uid] = u;
            });
          } else {
            classes = await window.FirebaseService.getClasses();
            groups = await window.FirebaseService.getGroups();
            works = await window.FirebaseService.getWorks();
            comments = await window.FirebaseService.getComments();
            users = await window.FirebaseService.getUsers();
            Object.values(users || {}).forEach(u => {
              if (u.uid) usersByUid[u.uid] = u;
            });
            cacheExhibitionData({ classes, groups, works, comments, users });
          }
          
          console.log('é–‹å§‹è¼‰å…¥å±•è¦½è³‡æ–™...');
          
          // ç”¢ç”Ÿç­ç´šæŒ‰éˆ•
          const classSelector = document.getElementById('class-selector');
          const mainContent = document.getElementById('main-content');
          
          if (!classSelector || !mainContent) {
            console.error('æ‰¾ä¸åˆ°å¿…è¦çš„ DOM å…ƒç´ ');
            return;
          }
          
          classSelector.innerHTML = '';
          mainContent.innerHTML = '';
          
          const classIds = Object.keys(classes || {});
          console.log('ç­ç´šåˆ—è¡¨:', classIds);
          
          if (classIds.length === 0) {
            mainContent.innerHTML = '<div style="text-align:center;padding:40px;color:#666;">æš«ç„¡ç­ç´šè³‡æ–™</div>';
            return;
          }
          
          classIds.forEach((classId, idx) => {
            const classData = classes[classId];
            if (!classData) return;
            
            // å»ºç«‹ç­ç´šæŒ‰éˆ•
            const btn = document.createElement('button');
            btn.className = 'class-btn' + (idx === 0 ? ' active' : '');
            btn.textContent = classData.name || classId;
            btn.setAttribute('data-class', classId);
            btn.onclick = () => {
              document.querySelectorAll('.class-btn').forEach(b => b.classList.remove('active'));
              btn.classList.add('active');
              document.querySelectorAll('.works-container').forEach(c => c.classList.remove('active'));
              const targetSection = document.getElementById('works-' + classId);
              if (targetSection) targetSection.classList.add('active');
            };
            classSelector.appendChild(btn);
            
            // å»ºç«‹å…§å®¹å€
            const section = document.createElement('section');
            section.className = 'works-container' + (idx === 0 ? ' active' : '');
            section.id = 'works-' + classId;
            
            // è©²ç­ç´šæ‰€æœ‰çµ„åˆ¥
            const allGroups = groups || {};
            const classGroups = [];
            
            // è™•ç†ä¸åŒçš„è³‡æ–™çµæ§‹
            if (allGroups[classId]) {
              // çµæ§‹ï¼šgroups[classId][groupId]
              classGroups.push(...Object.values(allGroups[classId]));
            } else {
              // çµæ§‹ï¼šgroups[groupId] with classId field
              Object.values(allGroups).forEach(group => {
                if (group && group.classId === classId) {
                  classGroups.push(group);
                }
              });
            }
            
            console.log(`ç­ç´š ${classId} çš„çµ„åˆ¥:`, classGroups);
            
            if (classGroups.length === 0) {
              section.innerHTML = '<div style="text-align:center;padding:40px;color:#666;">æš«ç„¡çµ„åˆ¥è³‡æ–™</div>';
            } else {
              classGroups.forEach(group => {
                if (!group) return;
                
                const groupDiv = document.createElement('div');
                groupDiv.className = 'group-section';
                groupDiv.innerHTML = `<div class="group-title">${group.name || 'æœªå‘½åçµ„åˆ¥'}</div>`;
                
                // è©²çµ„æ‰€æœ‰ä½œå“
                const groupWorks = Object.values(works || {}).filter(w => 
                  w && w.classId === classId && w.groupId === group.id && w.visible !== false
                );
                
                console.log(`çµ„åˆ¥ ${group.id} çš„ä½œå“æ•¸é‡:`, groupWorks.length);
                
                if (groupWorks.length === 0) {
                  groupDiv.innerHTML += '<div style="color:#aaa;padding:20px;text-align:center;">ï¼ˆæœ¬çµ„æš«ç„¡ä½œå“ï¼‰</div>';
                } else {
                  const worksGrid = document.createElement('div');
                  worksGrid.className = 'works-grid';
                  
                  groupWorks.forEach(work => {
                    if (!work) return;
                    
                    // å–å¾—è©²ä½œå“çš„è©•è«–
                    const workComments = Object.values(comments || {}).filter(c => 
                      c && c.workId === work.id
                    );
                    
                    // å»ºç«‹ä½œå“å¡ç‰‡
                    const workItem = document.createElement('div');
                    workItem.className = 'work-item';
                    
                    const cardContent = document.createElement('div');
                    cardContent.className = 'card-content';
                    
                    // å­¸ç”Ÿå§“å
                    const studentName = document.createElement('div');
                    studentName.className = 'student-name';
                    studentName.textContent = work.studentName || 'æœªçŸ¥å­¸ç”Ÿ';
                    cardContent.appendChild(studentName);
                    
                    // å½±ç‰‡é è¦½
                    const videoContainer = document.createElement('div');
                    videoContainer.className = 'video-container';
                    
                    if (work.videoUrl) {
                      const videoPreview = document.createElement('div');
                      videoPreview.className = 'video-preview';
                      videoPreview.style.background = '#222';
                      videoPreview.style.borderRadius = '14px 14px 0 0';
                      videoPreview.style.boxShadow = '0 2px 12px rgba(158,118,118,0.10)';
                      videoPreview.style.transition = 'box-shadow 0.3s, transform 0.3s';
                      videoPreview.style.overflow = 'hidden';
                      videoPreview.style.position = 'relative';
                      videoPreview.style.height = '0';
                      videoPreview.style.paddingBottom = '56.25%';
                      videoPreview.style.cursor = 'pointer';
                      // å–å¾— YouTube ID
                      const videoId = getYoutubeId(work.videoUrl);
                      if (videoId) {
                        // é è¨­ç”¨ maxresdefaultï¼Œå¤±æ•— fallback hqdefault
                        const thumbMax = `https://img.youtube.com/vi/${videoId}/maxresdefault.jpg`;
                        const thumbHQ = `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`;
                        const img = new window.Image();
                        img.src = thumbMax;
                        img.onload = function() {
                          if (img.naturalWidth <= 120) {
                            // maxresdefault ä¸å­˜åœ¨
                            videoPreview.style.backgroundImage = `url(${thumbHQ})`;
                          } else {
                            videoPreview.style.backgroundImage = `url(${thumbMax})`;
                          }
                        };
                        img.onerror = function() {
                          videoPreview.style.backgroundImage = `url(${thumbHQ})`;
                        };
                        // é è¨­å…ˆé¡¯ç¤º hqdefaultï¼Œç­‰ maxresdefault è¼‰å…¥æˆåŠŸå†åˆ‡æ›
                        videoPreview.style.backgroundImage = `url(${thumbHQ})`;
                        videoPreview.style.backgroundSize = 'cover';
                        videoPreview.style.backgroundPosition = 'center';
                        // æ’­æ”¾æŒ‰éˆ•
                        const playButton = document.createElement('div');
                        playButton.className = 'play-button';
                        playButton.style.cssText = `
                          position: absolute;
                          top: 50%;
                          left: 50%;
                          transform: translate(-50%, -50%);
                          width: 60px;
                          height: 40px;
                          background: rgba(0,0,0,0.7);
                          border-radius: 8px;
                          display: flex;
                          align-items: center;
                          justify-content: center;
                          color: white;
                          font-size: 20px;
                          box-shadow: 0 2px 8px rgba(0,0,0,0.18);
                        `;
                        playButton.innerHTML = 'â–¶';
                        videoPreview.appendChild(playButton);
                        // hover å‹•ç•«
                        videoPreview.onmouseenter = function() {
                          videoPreview.style.boxShadow = '0 8px 32px rgba(158,118,118,0.18)';
                          videoPreview.style.transform = 'translateY(-2px) scale(1.015)';
                        };
                        videoPreview.onmouseleave = function() {
                          videoPreview.style.boxShadow = '0 2px 12px rgba(158,118,118,0.10)';
                          videoPreview.style.transform = 'none';
                        };
                        videoPreview.onclick = function() {
                          const loading = document.createElement('div');
                          loading.className = 'loading-indicator';
                          loading.style.cssText = `
                            position: absolute;
                            top: 50%;
                            left: 50%;
                            transform: translate(-50%, -50%);
                            color: white;
                            font-size: 16px;
                            z-index: 100;
                          `;
                          loading.textContent = 'è¼‰å…¥ä¸­...';
                          videoContainer.appendChild(loading);
                          const iframe = document.createElement('iframe');
                          iframe.src = `${work.videoUrl}?autoplay=1&rel=0&modestbranding=1&playsinline=1`;
                          iframe.title = 'YouTube video player';
                          iframe.frameBorder = '0';
                          iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share';
                          iframe.allowFullscreen = true;
                          iframe.onload = function() { 
                            if (loading.parentNode) loading.remove(); 
                          };
                          videoPreview.remove();
                          videoContainer.appendChild(iframe);
                        };
                      }
                      videoContainer.appendChild(videoPreview);
                    } else {
                      videoContainer.innerHTML = '<div style="padding:40px;text-align:center;color:#999;">ç„¡å½±ç‰‡é€£çµ</div>';
                    }
                    
                    cardContent.appendChild(videoContainer);
                    
                    // ä½œå“æ¨™é¡Œ
                    const workTitle = document.createElement('div');
                    workTitle.className = 'work-title';
                    workTitle.textContent = work.title || 'æœªå‘½åä½œå“';
                    cardContent.appendChild(workTitle);
                    
                    workItem.appendChild(cardContent);
                    
                    // è©•è«–äº’å‹•å€å¡Šï¼ˆæ¯å€‹ä½œå“éƒ½è¦æœ‰ï¼‰
                    renderCommentsSection(work, workItem, workComments);
                    
                    worksGrid.appendChild(workItem);
                  });
                  
                  groupDiv.appendChild(worksGrid);
                }
                
                section.appendChild(groupDiv);
              });
            }
            
            mainContent.appendChild(section);
          });
          console.log('å±•è¦½æ¸²æŸ“å®Œæˆ');
          window._exhibitionCacheUsers = usersByUid;
          window._exhibitionCacheClasses = classes;
          window._exhibitionCacheGroups = groups;
        } catch (error) {
          console.error('æ¸²æŸ“å±•è¦½å¤±æ•—:', error);
          const mainContent = document.getElementById('main-content');
          if (mainContent) {
            mainContent.innerHTML = `
              <div style="text-align:center;padding:40px;color:#666;">
                <h3>è¼‰å…¥å¤±æ•—</h3>
                <p>ç„¡æ³•è¼‰å…¥å±•è¦½è³‡æ–™ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦ã€‚</p>
                <p style="font-size:12px;margin-top:20px;">éŒ¯èª¤è©³æƒ…: ${error.message}</p>
              </div>
            `;
          }
        }
      }
      
      // ====== é é¢è¼‰å…¥æ™‚å…ˆç”¨ cacheï¼Œå†æŠ“æ–°è³‡æ–™ ======
      document.addEventListener('DOMContentLoaded', function() {
        let cache = getExhibitionCache();
        if (cache) {
          renderExhibition(cache);
        }
        (async()=>{
          const classes = await window.FirebaseService.getClasses();
          const groups = await window.FirebaseService.getGroups();
          const works = await window.FirebaseService.getWorks();
          const comments = await window.FirebaseService.getComments();
          const users = await window.FirebaseService.getUsers();
          const newData = { classes, groups, works, comments, users };
          if (!cache || !isDataEqual(cache, newData)) {
            cacheExhibitionData(newData);
            renderExhibition(newData);
          } else {
            // åªæ›´æ–° cache æ™‚é–“
            cacheExhibitionData(newData);
          }
        })();
      });

      // ====== æµ®å‹•ç™»å…¥å¡ç‰‡ HTML çµæ§‹åˆå§‹åŒ– ======
      // (function(){
      //   if (!document.getElementById('auth-fab')) {
      //     const fabHtml = `
      //       <div id="auth-fab" class="auth-fab-modern" tabindex="0"></div>
      //       <div id="auth-panel-modern" class="auth-panel-modern" style="display:flex;"></div>
      //       <div id="auth-panel-bg" class="auth-panel-bg" style="display:none;"></div>
      //     `;
      //     document.body.insertAdjacentHTML('beforeend', fabHtml);
      //   }
      // })();
      // ====== æµ®å‹•ç™»å…¥å¡ç‰‡äº’å‹•æ§åˆ¶ ======
      function showModernAuthPanel() {
        document.getElementById('auth-panel-modern').classList.add('open');
        document.getElementById('auth-panel-bg').style.display = 'block';
      }
      function hideModernAuthPanel() {
        document.getElementById('auth-panel-modern').classList.remove('open');
        document.getElementById('auth-panel-bg').style.display = 'none';
      }
      function setupModernAuthFabEvents() {
        const fab = document.getElementById('auth-fab');
        const panel = document.getElementById('auth-panel-modern');
        const bg = document.getElementById('auth-panel-bg');
        if (fab && panel && bg) {
          fab.onclick = function(e) {
            if (panel.classList.contains('open')) {
              hideModernAuthPanel();
            } else {
              showModernAuthPanel();
            }
            e.stopPropagation();
          };
          bg.onclick = hideModernAuthPanel;
          // é»æ“Šå¤–éƒ¨æ”¶å›
          document.addEventListener('click', function(e) {
            if (panel.classList.contains('open') && !panel.contains(e.target) && e.target !== fab) {
              hideModernAuthPanel();
            }
          });
          // ESC æ”¶å›
          document.addEventListener('keydown', e => { if (panel.classList.contains('open') && e.key==='Escape') hideModernAuthPanel(); });
        }
      }
      // é é¢è¼‰å…¥å¾Œåˆå§‹åŒ–äº‹ä»¶
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', setupModernAuthFabEvents);
      } else {
        setupModernAuthFabEvents();
      }

      // ç§»é™¤åŸæœ‰ #auth-container å…§å®¹èˆ‡ CSSï¼Œæ”¹ç‚ºç¾ä»£æµ®å‹•å¡ç‰‡
      // 1. HTML çµæ§‹ï¼šåœ¨ body çµå°¾æ’å…¥ auth-fabã€auth-panel-modernã€auth-panel-bg
      // const fabHtml = `
      //   <div id="auth-fab" class="auth-fab-modern" tabindex="0"></div>
      //   <div id="auth-panel-modern" class="auth-panel-modern" style="display:none;"></div>
      //   <div id="auth-panel-bg" class="auth-panel-bg" style="display:none;"></div>
      // `;
      // document.body.insertAdjacentHTML('beforeend', fabHtml);

      // 2. CSS
      const modernAuthCss = document.createElement('style');
      modernAuthCss.innerHTML = `
      .auth-fab-modern {
        position: fixed; top: 24px; right: 24px; z-index: 2000;
        width: 60px; height: 60px; border-radius: 50%;
        background: linear-gradient(135deg, #e8c4c4, #d3a5a5);
        color: #fff; font-size: 2em; font-weight: bold;
        display: flex; align-items: center; justify-content: center;
        box-shadow: 0 6px 24px #b6868640;
        cursor: pointer; transition: box-shadow 0.2s, transform 0.2s;
      }
      .auth-fab-modern:hover { box-shadow: 0 12px 32px #b6868680; transform: scale(1.08);}
      .auth-panel-bg {
        position: fixed; inset: 0; background: rgba(0,0,0,0.12); z-index: 1999; backdrop-filter: blur(2px);
      }
      .auth-panel-modern {
        position: fixed; top: 20px; right: 90px; z-index: 2001;
        background: #fff; border-radius: 50px; box-shadow: 0 8px 32px #b6868640;
        padding: 0 2.2rem; min-width: 400px; min-height: 70px; max-width: 90vw;
        display: flex; flex-direction: row; align-items: center; gap: 1.1rem;
        transform: translateX(80%) scale(0.85);
        opacity: 0;
        pointer-events: none;
        transition:
          transform 0.55s cubic-bezier(.4,0,.2,1),
          opacity 0.38s cubic-bezier(.4,0,.2,1),
          box-shadow 0.38s cubic-bezier(.4,0,.2,1);
      }
      .auth-panel-modern.open {
        transform: translateX(0) scale(1);
        opacity: 1;
        pointer-events: auto;
        box-shadow: 0 16px 48px #b6868680;
      }
      .auth-panel-avatar {
        width: 56px; height: 56px; border-radius: 50%;
        background: #e8c4c4; color: #fff; font-size: 2em; font-weight: bold;
        display: flex; align-items: center; justify-content: center;
        margin-right: 0.5rem;
      }
      .auth-panel-info {
        display: flex; flex-direction: column; align-items: flex-start; min-width: 120px;
      }
      .auth-panel-name { font-weight: 700; color: #9e7676; font-size: 1.1em; }
      .auth-panel-meta { color: #888; font-size: 0.98em; margin-top: 2px; }
      .auth-panel-btns {
        display: flex; flex-direction: row; gap: 0.7em; margin-left: auto;
      }
      .auth-btn-modern {
        padding: 0.6em 1.2em; border-radius: 20px; border: none;
        background: linear-gradient(135deg, #e8c4c4, #d3a5a5);
        color: #fff; font-size: 1em; font-weight: 500;
        display: flex; align-items: center; gap: 0.5em;
        cursor: pointer; transition: background 0.2s, box-shadow 0.2s;
      }
      .auth-btn-modern.logout { background: linear-gradient(135deg, #e88, #b77);}
      .auth-btn-modern:hover { box-shadow: 0 2px 12px #b6868640;}
      @media (max-width: 600px) {
        .auth-fab-modern {
          width: 44px; height: 44px; font-size: 1.2em; top: 8px; right: 8px;
        }
        .auth-panel-modern {
          position: fixed;
          top: 56px;
          left: 0;
          right: 0;
          margin: 0 auto;
          width: 96vw;
          max-width: 420px;
          min-width: 0;
          padding: 0.7rem 0.7rem 0.5rem 0.7rem;
          border-radius: 22px;
          min-height: 0;
          flex-direction: column;
          align-items: stretch;
          gap: 0.5rem;
          transform: translateY(-40%) scale(0.95);
          opacity: 0;
          pointer-events: none;
          transition:
            transform 0.5s cubic-bezier(.4,0,.2,1),
            opacity 0.32s cubic-bezier(.4,0,.2,1),
            box-shadow 0.32s cubic-bezier(.4,0,.2,1);
        }
        .auth-panel-modern.open {
          transform: translateY(0) scale(1);
          opacity: 1;
          pointer-events: auto;
          box-shadow: 0 8px 32px #b6868680;
        }
        .auth-panel-avatar {
          width: 36px; height: 36px; font-size: 1em;
          margin: 0 auto 0.2rem auto;
        }
        .auth-panel-info {
          min-width: 0;
          font-size: 0.95em;
          align-items: center;
          text-align: center;
          margin-bottom: 0.2rem;
        }
        .auth-panel-name { font-size: 1em; }
        .auth-panel-meta { font-size: 0.9em; }
        .auth-panel-btns {
          gap: 0.3em;
          flex-wrap: wrap;
          margin-left: 0;
          justify-content: center;
          display: flex;
        }
        .auth-btn-modern {
          padding: 0.38em 0.7em;
          font-size: 0.92em;
          border-radius: 13px;
        }
      }
      `;
      document.head.appendChild(modernAuthCss);

      // 3. JS æ§åˆ¶
      function renderModernAuth() {
        const fab = document.getElementById('auth-fab');
        const panel = document.getElementById('auth-panel-modern');
        const bg = document.getElementById('auth-panel-bg');
        const isLogin = !!currentUser;
        // FAB å…§å®¹
        let avatar = 'ğŸ”‘';
        if (isLogin) avatar = (currentUser.displayName||currentUser.email||'')[0] || 'ğŸ‘¤';
        fab.innerHTML = `<span>${avatar}</span>`;
        // é¢æ¿å…§å®¹
        if (isLogin && window.currentProfile) {
          const classes = window._exhibitionCacheClasses || {};
          const groups = window._exhibitionCacheGroups || {};
          const className = classes[window.currentProfile.classId]?.name || '';
          const groupName = groups[window.currentProfile.groupId]?.name || '';
          const studentId = window.currentProfile.studentId || '';
          const avatarBig = (window.currentProfile.name||currentUser.email||'')[0] || 'ğŸ‘¤';
          panel.innerHTML = `
            <div class="auth-panel-avatar">${avatarBig}</div>
            <div class="auth-panel-info">
              <div class="auth-panel-name">${window.currentProfile.name || currentUser.email || 'æœªçŸ¥'}</div>
              <div class="auth-panel-meta">
                ${className ? `<span>${className}</span>` : ''}
                ${studentId ? `ï½œ<span>${studentId}</span>` : ''}
                ${groupName ? `ï½œ<span>${groupName}</span>` : ''}
              </div>
            </div>
            <div class="auth-panel-btns">
              <button class="auth-btn-modern" onclick="window.location.href='profile.html'"><span>å€‹äººå°ˆå€</span></button>
              <button class="auth-btn-modern logout" onclick="firebase.auth().signOut()"><span>ç™»å‡º</span></button>
            </div>
          `;
        } else {
          panel.innerHTML = `
            <div class="auth-panel-avatar">ğŸ”‘</div>
            <div class="auth-panel-info">
              <div class="auth-panel-name">æœªç™»å…¥</div>
              <div class="auth-panel-meta">è«‹å…ˆç™»å…¥ä»¥ç®¡ç†ä½œå“</div>
            </div>
            <div class="auth-panel-btns">
              <button class="auth-btn-modern" onclick="showLoginModal()"><span>ç™»å…¥ / è¨»å†Š</span></button>
            </div>
          `;
        }
        panel.classList.remove('open'); // é è¨­æ”¶åˆ
        document.getElementById('auth-panel-bg').style.display = 'none';
      }
      function showModernAuthPanel() {
        document.getElementById('auth-panel-modern').classList.add('open');
        document.getElementById('auth-panel-bg').style.display = 'block';
      }
      function hideModernAuthPanel() {
        document.getElementById('auth-panel-modern').classList.remove('open');
        document.getElementById('auth-panel-bg').style.display = 'none';
      }
      setTimeout(()=>{
        const fab = document.getElementById('auth-fab');
        const panel = document.getElementById('auth-panel-modern');
        const bg = document.getElementById('auth-panel-bg');
        if (fab && panel && bg) {
          fab.onclick = function(e) {
            if (panel.classList.contains('open')) {
              hideModernAuthPanel();
            } else {
              showModernAuthPanel();
            }
            e.stopPropagation();
          };
          bg.onclick = hideModernAuthPanel;
          // é»æ“Šå¤–éƒ¨æ”¶å›
          document.addEventListener('click', function(e) {
            if (panel.classList.contains('open') && !panel.contains(e.target) && e.target !== fab) {
              hideModernAuthPanel();
            }
          });
          // ESC æ”¶å›
          document.addEventListener('keydown', e => { if (panel.classList.contains('open') && e.key==='Escape') hideModernAuthPanel(); });
        }
      }, 500);
      // ç™»å…¥ç‹€æ…‹è®ŠåŒ–æ™‚æ¸²æŸ“
      if (window.firebase && window.firebase.auth) {
        window.firebase.auth().onAuthStateChanged(user => {
          renderModernAuth();
          hideModernAuthPanel();
        });
      }
      // å±•è¦½è³‡æ–™è¼‰å…¥å¾Œä¹Ÿè¦æ¸²æŸ“
      function afterExhibitionLoaded() { renderModernAuth(); }

      // é¡¯ç¤ºç™»å…¥ Modal
      function showLoginModal() {
        const modal = document.getElementById('login-modal');
        if (modal) {
          modal.style.display = 'block';
        }
      }
      
      // é—œé–‰ç™»å…¥ Modal
      function closeLoginModal() {
        const modal = document.getElementById('login-modal');
        if (modal) {
          modal.style.display = 'none';
        }
      }
      
      // åˆ‡æ›ç™»å…¥/è¨»å†Šæ¨™ç±¤
      function switchLoginTab(tabName) {
        // éš±è—æ‰€æœ‰è¡¨å–®
        document.querySelectorAll('#login-modal .login-form').forEach(form => {
          form.style.display = 'none';
        });
        // ç§»é™¤æ‰€æœ‰æ¨™ç±¤çš„ active é¡
        document.querySelectorAll('#login-modal .tab-btn').forEach(btn => {
          btn.classList.remove('active');
        });
        // é¡¯ç¤ºå°æ‡‰çš„è¡¨å–®å’Œæ¨™ç±¤
        if(tabName==='email') {
          document.getElementById('email-form').style.display = 'block';
        } else if(tabName==='google') {
          document.getElementById('google-form').style.display = 'block';
        } else if(tabName==='anonymous') {
          document.getElementById('anonymous-form').style.display = 'block';
        }
        document.getElementById(tabName+'-tab').classList.add('active');
        // åˆ‡å›ç™»å…¥è¡¨å–®
        showLoginForm();
      }
      // é¡¯ç¤ºè¨»å†Šè¡¨å–®
      function showRegisterForm() {
        document.getElementById('email-form').style.display = 'none';
        document.getElementById('register-form-wrap').style.display = 'block';
        // è¼‰å…¥ç­ç´š/çµ„åˆ¥
        loadClassAndGroupOptions();
      }
      // é¡¯ç¤ºç™»å…¥è¡¨å–®
      function showLoginForm() {
        document.getElementById('register-form-wrap').style.display = 'none';
        document.getElementById('email-form').style.display = 'block';
      }
      // è¼‰å…¥ç­ç´š/çµ„åˆ¥ä¸‹æ‹‰
      async function loadClassAndGroupOptions() {
        const classSel = document.getElementById('reg-class-modal');
        const groupSel = document.getElementById('reg-group-modal');
        let allClasses = {};
        let allGroups = {};
        try {
          allClasses = await window.FirebaseService.getClasses();
          classSel.innerHTML = '<option value="">è«‹é¸æ“‡ç­ç´š</option>';
          Object.values(allClasses).forEach(cls => {
            if (cls.visible === false) return; // è·³ééš±è—ç­ç´š
            classSel.innerHTML += `<option value="${cls.id}">${cls.name}ï¼ˆ${cls.year||''}ï¼‰</option>`;
          });
        } catch (err) {
          classSel.innerHTML = '<option value="">è¼‰å…¥å¤±æ•—</option>';
        }
        allGroups = await window.FirebaseService.getGroups();
        classSel.onchange = function() {
          const classId = classSel.value;
          groupSel.innerHTML = '<option value="">è«‹é¸æ“‡çµ„åˆ¥</option>';
          Object.values(allGroups).filter(g => g.classId === classId).forEach(g => {
            groupSel.innerHTML += `<option value="${g.id}">${g.name}</option>`;
          });
        };
      }
      // è¨»å†Šé€å‡º
      document.addEventListener('DOMContentLoaded', function() {
        const regForm = document.getElementById('register-form-modal');
        if(regForm) {
          regForm.onsubmit = async function(e) {
            e.preventDefault();
            const isGoogle = regForm.getAttribute('data-google') === '1';
            const email = document.getElementById('reg-email-modal').value.trim();
            const name = document.getElementById('reg-name-modal').value.trim();
            const studentId = document.getElementById('reg-studentid-modal').value.trim();
            const classId = document.getElementById('reg-class-modal').value;
            const groupId = document.getElementById('reg-group-modal').value;
            if (!name || !studentId || !classId || !groupId) {
              alert('è«‹å®Œæ•´å¡«å¯«æ‰€æœ‰æ¬„ä½');
              return;
            }
            if (isGoogle) {
              // å–å¾—ç›®å‰ç™»å…¥çš„ Google user
              const user = firebase.auth().currentUser;
              await window.FirebaseService.addUser({
                uid: user.uid,
                email: user.email,
                name,
                studentId,
                classId,
                groupId,
                role: 'student',
                createdAt: new Date().toISOString()
              });
              alert('è³‡æ–™å·²è£œé½Šï¼Œç™»å…¥æˆåŠŸï¼');
              regForm.setAttribute('data-google', '');
              showLoginForm();
              closeLoginModal();
            } else {
              try {
                const password = document.getElementById('reg-password-modal').value;
                if (!email || !password) {
                  alert('è«‹è¼¸å…¥ Email å’Œå¯†ç¢¼');
                  return;
                }
                const result = await firebase.auth().createUserWithEmailAndPassword(email, password);
                await window.FirebaseService.addUser({
                  uid: result.user.uid,
                  email,
                  name,
                  studentId,
                  classId,
                  groupId,
                  role: 'student',
                  createdAt: new Date().toISOString()
                });
                alert('è¨»å†ŠæˆåŠŸï¼');
                showLoginForm();
                closeLoginModal();
              } catch (err) {
                alert('è¨»å†Šå¤±æ•—ï¼š' + err.message);
              }
            }
          };
        }
      
      // Email ç™»å…¥
      window.doLoginWithEmail = function() {
        const email = document.getElementById('login-email').value.trim();
        const password = document.getElementById('login-password').value;
        if (!email || !password) {
          alert('è«‹è¼¸å…¥ Email å’Œå¯†ç¢¼');
          return;
        }
        firebase.auth().signInWithEmailAndPassword(email, password)
          .then(() => {
            alert('ç™»å…¥æˆåŠŸï¼');
            closeLoginModal();
          })
          .catch(error => {
            alert('ç™»å…¥å¤±æ•—ï¼š' + error.message);
          });
      }
    });
      
      // Google ç™»å…¥
      async function loginWithGoogle() {
        try {
          const provider = new firebase.auth.GoogleAuthProvider();
          const result = await firebase.auth().signInWithPopup(provider);
          const uid = result.user.uid;
          // æŸ¥ users æœ‰æ²’æœ‰é€™å€‹ uid
          const userProfile = await window.FirebaseService.getCurrentUserProfile(uid);
          if (userProfile) {
            alert('Google ç™»å…¥æˆåŠŸï¼');
            setTimeout(closeLoginModal, 1500);
          } else {
            // æ²’æœ‰è³‡æ–™ï¼Œé¡¯ç¤ºè£œé½Šè¡¨å–®
            showGoogleRegisterForm(result.user);
          }
        } catch (error) {
          alert('Google ç™»å…¥å¤±æ•—ï¼š' + error.message);
        }
      }
      
      // åŒ¿åç™»å…¥
      async function loginAnonymously() {
        try {
          const result = await firebase.auth().signInAnonymously();
          
          // è‡ªå‹•è£œé½Šç”¨æˆ¶è³‡æ–™
          await window.FirebaseService.addUser({
            uid: result.user.uid,
            email: 'anonymous@example.com',
            name: 'åŒ¿åç”¨æˆ¶',
            role: 'student',
            createdAt: new Date().toISOString()
          });
          
          alert('åŒ¿åç™»å…¥æˆåŠŸï¼');
          setTimeout(closeLoginModal, 1500);
        } catch (error) {
          alert('åŒ¿åç™»å…¥å¤±æ•—ï¼š' + error.message);
        }
      }
      
      // é»æ“Š Modal èƒŒæ™¯é—œé–‰
      document.addEventListener('click', function(e) {
        const modal = document.getElementById('login-modal');
        if (e.target === modal) {
          closeLoginModal();
        }
      });

      // å°‡è©•è«–å€å¡Šæ¸²æŸ“é‚è¼¯æŠ½æˆ function
      function renderCommentsSection(work, workItem, workComments) {
        // å…ˆç§»é™¤èˆŠçš„ commentsSection
        const oldSection = workItem.querySelector('.comments-section');
        if (oldSection) oldSection.remove();

        const commentsSection = document.createElement('div');
        commentsSection.className = 'comments-section';

        // å¹³å‡æ˜Ÿç­‰
        const avgRating = workComments.length > 0 ? (workComments.reduce((sum, c) => sum + (c.rating || 0), 0) / workComments.length).toFixed(1) : null;
        const avgStars = avgRating ? 'â˜…'.repeat(Math.round(avgRating)) + 'â˜†'.repeat(5 - Math.round(avgRating)) : '';
        const avgRatingDiv = document.createElement('div');
        avgRatingDiv.style.cssText = 'padding:8px 12px;color:#b77;font-weight:600;display:flex;align-items:center;gap:12px;';
        avgRatingDiv.innerHTML = avgRating ? `å¹³å‡æ˜Ÿç­‰ï¼š<span class=\"rating-stars\">${avgStars}</span> <span style=\"color:#888;font-size:0.95em;\">${avgRating} / 5</span>` : '<span style=\"color:#aaa;\">å°šç„¡è©•åˆ†</span>';
        commentsSection.appendChild(avgRatingDiv);

        // ã€ç•™è¨€ã€æŒ‰éˆ•
        const showFormBtn = document.createElement('button');
        showFormBtn.className = 'auth-btn';
        showFormBtn.textContent = 'ç•™è¨€';
        showFormBtn.style.margin = '8px 0 0 12px';
        showFormBtn.style.display = currentUser ? '' : 'none';
        commentsSection.appendChild(showFormBtn);

        // è©•è«–è¡¨å–®ï¼ˆé è¨­éš±è—ï¼Œä¸”åªå»ºç«‹ä¸€æ¬¡ï¼‰
        const commentFormDiv = document.createElement('div');
        commentFormDiv.className = 'comment-form';
        commentFormDiv.style.cssText = 'padding:12px 0 0 0;border-top:1px solid #eee;display:none;';
        if (!currentUser) {
          commentFormDiv.innerHTML = '<div style="color:#888;text-align:center;">è«‹å…ˆç™»å…¥æ‰èƒ½è©•è«–</div>';
        } else {
          const myComment = workComments.find(c => c.reviewerId === currentUser.uid);
          let rating = myComment ? myComment.rating : 0;
          let content = myComment ? myComment.content : '';
          const form = document.createElement('form');
          form.style.cssText = 'display:flex;flex-direction:column;align-items:center;gap:8px;';
          const starsDiv = document.createElement('div');
          starsDiv.style.cssText = 'font-size:1.5em;color:#e8c4c4;cursor:pointer;';
          function renderStars() {
            starsDiv.innerHTML = '';
            for(let i=1;i<=5;i++){
              const star = document.createElement('span');
              star.textContent = i <= rating ? 'â˜…' : 'â˜†';
              star.style.margin = '0 2px';
              star.onclick = ()=>{ rating=i; renderStars(); };
              starsDiv.appendChild(star);
            }
          }
          renderStars();
          form.appendChild(starsDiv);
          const textarea = document.createElement('textarea');
          textarea.value = content;
          textarea.placeholder = 'è«‹è¼¸å…¥è©•è«–...';
          textarea.style.cssText = 'width:100%;max-width:340px;min-height:48px;border-radius:6px;border:1px solid #ccc;padding:6px 10px;resize:vertical;';
          form.appendChild(textarea);
          const submitBtn = document.createElement('button');
          submitBtn.type = 'submit';
          submitBtn.className = 'auth-btn';
          submitBtn.textContent = myComment ? 'ä¿®æ”¹è©•è«–' : 'é€å‡ºè©•è«–';
          form.appendChild(submitBtn);
          form.onsubmit = async (e) => {
            e.preventDefault();
            if (rating < 1 || rating > 5) { alert('è«‹é¸æ“‡æ˜Ÿç­‰ï¼ˆ1~5é¡†ï¼‰'); return; }
            if (!textarea.value.trim()) { alert('è«‹è¼¸å…¥è©•è«–å…§å®¹'); return; }
            submitBtn.disabled = true;
            try {
              await window.FirebaseService.addOrUpdateComment({
                workId: work.id,
                reviewerId: currentUser.uid,
                reviewerName: window.currentProfile?.name || currentUser.email || 'åŒ¿å',
                reviewerClass: window.currentProfile?.classId || '',
                content: textarea.value.trim(),
                rating: rating
              });
              alert('è©•è«–å·²é€å‡ºï¼');
              commentFormDiv.style.display = 'none';
              // åªåˆ·æ–°è©²å¡ç‰‡ç•™è¨€å€
              const allComments = await window.FirebaseService.getComments();
              const newWorkComments = Object.values(allComments || {}).filter(c => c && c.workId === work.id);
              renderCommentsSection(work, workItem, newWorkComments);
            } catch (err) {
              alert('é€å‡ºå¤±æ•—ï¼š' + err.message);
            }
            submitBtn.disabled = false;
          };
          commentFormDiv.appendChild(form);
        }
        commentsSection.appendChild(commentFormDiv);
        showFormBtn.onclick = () => {
          commentFormDiv.style.display = commentFormDiv.style.display === 'none' ? '' : 'none';
        };

        // ç•™è¨€ä¸²ï¼ˆthreadï¼Œé è¨­æ”¶åˆï¼‰
        if (workComments.length > 0) {
          const commentsHeader = document.createElement('div');
          commentsHeader.className = 'comments-header';
          commentsHeader.style.cssText = 'padding: 8px 12px; background: #f8f8f8; border-top: 1px solid #eee; cursor:pointer;';
          const commentsTitle = document.createElement('div');
          commentsTitle.className = 'comments-title';
          commentsTitle.innerHTML = `<span>ç•™è¨€ä¸²</span><span class=\"comments-count\">${workComments.length}</span> <span class=\"toggle-arrow\" style=\"margin-left:8px;\">â–¶</span>`;
          commentsHeader.appendChild(commentsTitle);
          commentsSection.appendChild(commentsHeader);
          const commentsContent = document.createElement('div');
          commentsContent.className = 'comments-content';
          commentsContent.style.background = '#fff';
          commentsContent.style.padding = '12px';
          commentsContent.style.display = 'none';
          const commentsList = document.createElement('div');
          commentsList.className = 'comments-list';
          // å–å¾—æ‰€æœ‰ç”¨æˆ¶è³‡æ–™ã€ç­ç´šã€çµ„åˆ¥
          const users = window._exhibitionCacheUsers || {};
          const classes = window._exhibitionCacheClasses || {};
          const groups = window._exhibitionCacheGroups || {};
          workComments.forEach(comment => {
            const commentElement = document.createElement('div');
            commentElement.className = 'comment';
            commentElement.style.cssText = 'border-bottom: 1px solid #eee; padding: 8px 0; margin-bottom: 8px;';
            const commentHeader = document.createElement('div');
            commentHeader.className = 'comment-header';
            commentHeader.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; font-size: 12px; color: #666;';
            const commenterInfo = document.createElement('div');
            commenterInfo.className = 'commenter-info';
            const ratingStars = 'â˜…'.repeat(comment.rating || 0) + 'â˜†'.repeat(5-(comment.rating || 0));
            // å–å¾— reviewerId å°æ‡‰çš„ user
            const user = users[comment.reviewerId] || {};
            const className = classes[user.classId]?.name || user.classId || '';
            const groupName = groups[user.groupId]?.name || user.groupId || '';
            const studentId = user.studentId || '';
            commenterInfo.innerHTML = `
              <span class=\"commenter-name\">${comment.reviewerName || 'åŒ¿å'}</span>
              <span class=\"commenter-meta\" style=\"margin-left:8px;color:#b68686;font-size:0.98em;\">
                ${className ? `<span class=\"commenter-class\">${className}</span>` : ''}
                ${studentId ? `<span class=\"commenter-studentid\" style=\"margin-left:6px;\">å­¸è™Ÿ:${studentId}</span>` : ''}
                ${groupName ? `<span class=\"commenter-group\" style=\"margin-left:6px;\">${groupName}</span>` : ''}
              </span>
              <span class=\"rating-stars\" title=\"${comment.rating || 0}åˆ†\" style=\"margin-left:10px;\">${ratingStars}</span>
            `;
            commentHeader.appendChild(commenterInfo);
            commentElement.appendChild(commentHeader);
            const commentContent = document.createElement('div');
            commentContent.className = 'comment-content';
            commentContent.textContent = comment.content || '';
            commentContent.style.cssText = 'font-size: 14px; line-height: 1.4; color: #333;';
            commentElement.appendChild(commentContent);
            // ====== ç®¡ç†å“¡åˆªé™¤è©•è«–æŒ‰éˆ• ======
            if (window.currentProfile && window.currentProfile.role === 'admin') {
              const delBtn = document.createElement('button');
              delBtn.className = 'auth-btn';
              delBtn.style.background = '#e88';
              delBtn.style.marginLeft = '8px';
              delBtn.textContent = 'åˆªé™¤';
              delBtn.onclick = async function() {
                if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å‰‡è©•è«–ï¼Ÿ')) return;
                try {
                  await firebase.database().ref('comments/' + comment.id).remove();
                  alert('å·²åˆªé™¤ï¼');
                  // åªåˆ·æ–°è©²å¡ç‰‡ç•™è¨€å€
                  const allComments = await window.FirebaseService.getComments();
                  const newWorkComments = Object.values(allComments || {}).filter(c => c && c.workId === work.id);
                  renderCommentsSection(work, workItem, newWorkComments);
                } catch (err) {
                  alert('åˆªé™¤å¤±æ•—ï¼š' + err.message);
                }
              };
              commentElement.appendChild(delBtn);
            }
            commentsList.appendChild(commentElement);
          });
          commentsContent.appendChild(commentsList);
          commentsSection.appendChild(commentsContent);
          commentsHeader.onclick = function() {
            const arrow = commentsHeader.querySelector('.toggle-arrow');
            if (commentsContent.style.display === 'none') {
              commentsContent.style.display = '';
              if (arrow) arrow.textContent = 'â–¼';
            } else {
              commentsContent.style.display = 'none';
              if (arrow) arrow.textContent = 'â–¶';
            }
          };
        }
        workItem.appendChild(commentsSection);
      }

      // å–å¾— YouTube IDï¼ˆæ”¯æ´å¤šç¨®æ ¼å¼ï¼‰
      function getYoutubeId(url) {
        let id = '';
        if (!url) return '';
        if (url.includes('youtu.be/')) {
          id = url.split('youtu.be/')[1].split(/[?&]/)[0];
        } else if (url.includes('watch?v=')) {
          id = url.split('watch?v=')[1].split(/[?&]/)[0];
        } else if (url.includes('/embed/')) {
          id = url.split('/embed/')[1].split(/[?&]/)[0];
        }
        return id;
      }

      function showGoogleRegisterForm(user) {
        // é¡¯ç¤ºè¨»å†Šè¡¨å–®
        document.getElementById('email-form').style.display = 'none';
        document.getElementById('register-form-wrap').style.display = 'block';
        // éš±è— email/password æ¬„ä½
        document.getElementById('reg-email-modal').value = user.email || '';
        document.getElementById('reg-email-modal').readOnly = true;
        document.getElementById('reg-email-modal').parentElement.style.display = 'none';
        document.getElementById('reg-password-modal').parentElement.style.display = 'none';
        // é è¨­å¡«å…¥ Google åå­—
        document.getElementById('reg-name-modal').value = user.displayName || user.email.split('@')[0];
        // å…¶é¤˜æ¬„ä½æ¸…ç©º
        document.getElementById('reg-studentid-modal').value = '';
        document.getElementById('reg-class-modal').value = '';
        document.getElementById('reg-group-modal').value = '';
        // æ¨™è¨˜æ˜¯ Google è£œé½Šæ¨¡å¼
        document.getElementById('register-form-modal').setAttribute('data-google', '1');
        loadClassAndGroupOptions();
      }
    </script>
</body>
</html>