<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å­¸ç”Ÿåå–®ç®¡ç†ï¼ˆBootstrap ç‰ˆï¼‰</title>
  <!-- Bootstrap 5 CSS CDN -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="bg-light">

  <div class="container py-4">
    <h1 class="mb-4 text-center">ğŸ“š å­¸ç”Ÿåå–®ç®¡ç†</h1>

    <!-- å­¸ç”Ÿåˆ—è¡¨å€ -->
    <ul id="student-list" class="list-group mb-4">
      <li class="list-group-item text-center text-muted">è¼‰å…¥ä¸­...</li>
    </ul>

    <hr />

    <!-- è¡¨å–®å€ -->
    <h2 id="form-title" class="mb-3">â• æ–°å¢å­¸ç”Ÿ</h2>

    <form id="student-form" class="row g-3 needs-validation" novalidate>
      <div class="col-md-4">
        <input
          type="text"
          id="student-id"
          class="form-control"
          placeholder="å­¸è™Ÿ"
          required
        />
        <div class="invalid-feedback">è«‹è¼¸å…¥å­¸è™Ÿ</div>
      </div>
      <div class="col-md-6">
        <input
          type="text"
          id="student-name"
          class="form-control"
          placeholder="å§“å"
          required
        />
        <div class="invalid-feedback">è«‹è¼¸å…¥å§“å</div>
      </div>
      <div class="col-md-2 d-flex align-items-center">
        <button type="submit" class="btn btn-primary me-2">é€å‡º</button>
        <button type="button" id="cancel-edit" class="btn btn-secondary" style="display:none;">å–æ¶ˆ</button>
      </div>
    </form>
  </div>

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <!-- Bootstrap 5 JS Bundleï¼ˆå« Popperï¼‰-->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // åˆå§‹åŒ– Firebase
    var firebaseConfig = {
      databaseURL: "https://app1-7c1ad-default-rtdb.firebaseio.com/"
    };
    firebase.initializeApp(firebaseConfig);
    var db = firebase.database();
    var studentsRef = db.ref("students");

    var editingKey = null; // æ­£åœ¨ç·¨è¼¯çš„ key

    // è¼‰å…¥å­¸ç”Ÿè³‡æ–™
    function loadStudents() {
      studentsRef.once("value").then(function(snapshot) {
        var data = snapshot.val();
        var list = document.getElementById("student-list");
        list.innerHTML = "";
        if (!data) {
          list.innerHTML = '<li class="list-group-item text-center text-muted">ç›®å‰æ²’æœ‰å­¸ç”Ÿè³‡æ–™</li>';
          return;
        }
        for (var key in data) {
          var student = data[key];

          // li
          var li = document.createElement("li");
          li.className = "list-group-item d-flex justify-content-between align-items-center";

          // æ–‡å­—å€
          var textDiv = document.createElement("div");
          textDiv.textContent = `å­¸è™Ÿï¼š${student.id}ï¼Œå§“åï¼š${student.name}`;

          // æŒ‰éˆ•ç¾¤
          var btnGroup = document.createElement("div");

          // ä¿®æ”¹æŒ‰éˆ•
          var editBtn = document.createElement("button");
          editBtn.className = "btn btn-sm btn-outline-primary me-2";
          editBtn.textContent = "ä¿®æ”¹";
          editBtn.onclick = (function(k, s) {
            return function() {
              startEdit(k, s);
            };
          })(key, student);

          // åˆªé™¤æŒ‰éˆ•
          var delBtn = document.createElement("button");
          delBtn.className = "btn btn-sm btn-outline-danger";
          delBtn.textContent = "åˆªé™¤";
          delBtn.onclick = (function(k) {
            return function() {
              if (confirm("ç¢ºå®šè¦åˆªé™¤é€™ä½å­¸ç”Ÿï¼Ÿ")) {
                studentsRef.child(k).remove().then(loadStudents);
              }
            };
          })(key);

          btnGroup.appendChild(editBtn);
          btnGroup.appendChild(delBtn);

          li.appendChild(textDiv);
          li.appendChild(btnGroup);

          list.appendChild(li);
        }
      });
    }

    // è¡¨å–®é©—è­‰èˆ‡é€å‡º
    document.getElementById("student-form").addEventListener("submit", function(event) {
      event.preventDefault();
      event.stopPropagation();

      var form = event.target;
      if (!form.checkValidity()) {
        form.classList.add("was-validated");
        return;
      }

      submitStudent();
    }, false);

    // é€å‡ºæ–°å¢æˆ–ä¿®æ”¹
    function submitStudent() {
      var id = document.getElementById("student-id").value.trim();
      var name = document.getElementById("student-name").value.trim();

      if (editingKey) {
        // ç·¨è¼¯æ¨¡å¼
        studentsRef.child(editingKey).set({ id: id, name: name }).then(() => {
          cancelEdit();
          loadStudents();
          resetFormValidation();
        }).catch(err => alert("æ›´æ–°å¤±æ•—ï¼š" + err));
      } else {
        // æ–°å¢æ¨¡å¼
        studentsRef.push({ id: id, name: name }).then(() => {
          clearForm();
          loadStudents();
          resetFormValidation();
        }).catch(err => alert("æ–°å¢å¤±æ•—ï¼š" + err));
      }
    }

    // é–‹å§‹ç·¨è¼¯
    function startEdit(key, student) {
      editingKey = key;
      document.getElementById("student-id").value = student.id;
      document.getElementById("student-name").value = student.name;
      document.getElementById("form-title").textContent = "ğŸ“ ç·¨è¼¯å­¸ç”Ÿ";
      document.getElementById("cancel-edit").style.display = "inline-block";
    }

    // å–æ¶ˆç·¨è¼¯
    function cancelEdit() {
      editingKey = null;
      clearForm();
      document.getElementById("form-title").textContent = "â• æ–°å¢å­¸ç”Ÿ";
      document.getElementById("cancel-edit").style.display = "none";
      resetFormValidation();
    }

    // æ¸…ç©ºè¡¨å–®æ¬„ä½
    function clearForm() {
      document.getElementById("student-id").value = "";
      document.getElementById("student-name").value = "";
    }

    // é‡ç½®é©—è­‰ç‹€æ…‹
    function resetFormValidation() {
      var form = document.getElementById("student-form");
      form.classList.remove("was-validated");
    }

    // å–æ¶ˆæŒ‰éˆ•äº‹ä»¶
    document.getElementById("cancel-edit").addEventListener("click", cancelEdit);

    // åˆå§‹è¼‰å…¥
    window.onload = loadStudents;
  </script>
</body>
</html>
